<!DOCTYPE html>





<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Geospatial DataGeo json架構 必須是一個stucture結構 cordinate的第一個屬性是經度，第二個為緯度  12//type與coordinate是一定要有的db.places.insertOne(&amp;#123;name: &quot;Califorina Academy&quot;, location: &amp;#123;type: &quot;Point&quot;, coordinates: [-122.4">
<meta name="keywords" content="backend,database,mongoDB,mongo shell">
<meta property="og:type" content="article">
<meta property="og:title" content="mongoDB 基礎2">
<meta property="og:url" content="http://yencheng.com/2019/08/23/mongodb/index.html">
<meta property="og:site_name" content="yencheng&#39;s code blog">
<meta property="og:description" content="Geospatial DataGeo json架構 必須是一個stucture結構 cordinate的第一個屬性是經度，第二個為緯度  12//type與coordinate是一定要有的db.places.insertOne(&amp;#123;name: &quot;Califorina Academy&quot;, location: &amp;#123;type: &quot;Point&quot;, coordinates: [-122.4">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-09-05T11:51:03.584Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mongoDB 基礎2">
<meta name="twitter:description" content="Geospatial DataGeo json架構 必須是一個stucture結構 cordinate的第一個屬性是經度，第二個為緯度  12//type與coordinate是一定要有的db.places.insertOne(&amp;#123;name: &quot;Califorina Academy&quot;, location: &amp;#123;type: &quot;Point&quot;, coordinates: [-122.4">
  <link rel="canonical" href="http://yencheng.com/2019/08/23/mongodb/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>mongoDB 基礎2 | yencheng's code blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yencheng's code blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yencheng.com/2019/08/23/mongodb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YENCHENG LIU">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yencheng's code blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">mongoDB 基礎2

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-08-23 15:36:24" itemprop="dateCreated datePublished" datetime="2019-08-23T15:36:24+09:00">2019-08-23</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-09-05 20:51:03" itemprop="dateModified" datetime="2019-09-05T20:51:03+09:00">2019-09-05</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MongoDB/" itemprop="url" rel="index"><span itemprop="name">MongoDB</span></a></span>

                
                
              
            </span>
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <hr>
<h1 id="Geospatial-Data"><a href="#Geospatial-Data" class="headerlink" title="Geospatial Data"></a>Geospatial Data</h1><h2 id="Geo-json架構"><a href="#Geo-json架構" class="headerlink" title="Geo json架構"></a>Geo json架構</h2><ul>
<li>必須是一個stucture結構</li>
<li>cordinate的第一個屬性是經度，第二個為緯度</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//type與coordinate是一定要有的</span></span><br><span class="line">db.places.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Califorina Academy"</span>, <span class="attr">location</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.4724356</span>, <span class="number">37.7672544</span>]&#125;&#125;)</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<h2 id="使用find找出與現在位置接近的點資料"><a href="#使用find找出與現在位置接近的點資料" class="headerlink" title="使用find找出與現在位置接近的點資料"></a>使用find找出與現在位置接近的點資料</h2><ul>
<li>$near: 是mongodb提供給geospatial data的一種方法，必須配合geospatial index</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.places.createIndex(&#123;<span class="attr">location</span>: <span class="string">"2dsphere"</span>&#125;) <span class="comment">//2dsphere是特別給geo資料用的index型態</span></span><br><span class="line"><span class="comment">//以下query會找到上面所加的點，$geometry代表後面接的是一個geo json結構的資料</span></span><br><span class="line">db.places.find(&#123;<span class="attr">location</span>: &#123;<span class="attr">$near</span>: &#123;<span class="attr">$geometry</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.47114</span>, <span class="number">37.771104</span>]&#125;&#125;&#125;)</span><br><span class="line"><span class="comment">//為了讓query變的更有意義，可以加一些參數。$maxDistance代表離自己最遠幾公尺內，#minDistance代表至少要離自己幾公尺</span></span><br><span class="line">db.places.find(&#123;<span class="attr">location</span>: &#123;<span class="attr">$near</span>: &#123;<span class="attr">$geometry</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.47114</span>, <span class="number">37.771104</span>]&#125;, <span class="attr">$maxDistance</span>: <span class="number">500</span>, <span class="attr">$minDistance</span>: <span class="number">10</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="找出一個面積內所包含的點資料"><a href="#找出一個面積內所包含的點資料" class="headerlink" title="找出一個面積內所包含的點資料"></a>找出一個面積內所包含的點資料</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先再加入更多的點資料，包含上面的資料前三個資料在Golden Gate Park裡面，最後一個在外面</span></span><br><span class="line">db.places.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Conservatory of Flowers"</span>, <span class="attr">location</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.4615748</span>, <span class="number">37.7701756</span>]&#125;&#125;)</span><br><span class="line">db.places.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Golden Gate Tennis Park"</span>, <span class="attr">location</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.4593702</span>, <span class="number">37.7705046</span>]&#125;&#125;)</span><br><span class="line">db.places.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Nopa"</span>, <span class="attr">location</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.4389058</span>, <span class="number">37.7747415</span>]&#125;&#125;)</span><br><span class="line"><span class="comment">//接著利用googlemap抓出圍住公園的四個點</span></span><br><span class="line"><span class="keyword">const</span> p1 = [<span class="number">-122.4547</span>, <span class="number">37.77473</span>]</span><br><span class="line"><span class="keyword">const</span> p2 = [<span class="number">-122.45303</span>, <span class="number">37.76641</span>]</span><br><span class="line"><span class="keyword">const</span> p3 = [<span class="number">-122.51026</span>, <span class="number">37.76411</span>]</span><br><span class="line"><span class="keyword">const</span> p4 = [<span class="number">-122.51088</span>, <span class="number">37.77131</span>]</span><br><span class="line"><span class="comment">//$geoWithin特別用來搜尋elements是否在一個特定的面之內。coordinates內是一個array再包一個array後，裡面再包住含經緯度的array</span></span><br><span class="line"><span class="comment">//$geoWithin不要求index(有的話可以提升query速度)，但是有用到$near就需要有index</span></span><br><span class="line"><span class="comment">//起始點p1要再重複一次代表一個完整的Polygon已經結束</span></span><br><span class="line"><span class="comment">//以下的query將會找出有在公園內的點(也就是除了Nova以外的點)</span></span><br><span class="line">db.places.find(&#123;<span class="attr">location</span>: &#123;<span class="attr">$geoWithin</span>: &#123;<span class="attr">$geometry</span>: &#123;<span class="attr">type</span>: <span class="string">"Polygon"</span>, <span class="attr">coordinates</span>: [[p1, p2, p3, p4, p1]]&#125;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="確認一個點資料-user-是否在一個特定的範圍內"><a href="#確認一個點資料-user-是否在一個特定的範圍內" class="headerlink" title="確認一個點資料(user)是否在一個特定的範圍內"></a>確認一個點資料(user)是否在一個特定的範圍內</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先把剛剛公園的area資料加入資料庫</span></span><br><span class="line">db.areas.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Golden Gate Park"</span>, <span class="attr">area</span>: &#123;<span class="attr">type</span>: <span class="string">"Polygon"</span>, <span class="attr">coordinates</span>: [[p1, p2, p3, p4, p1]]&#125;&#125;)</span><br><span class="line"><span class="comment">//在下query之前必須先加入index</span></span><br><span class="line">db.areas.createIndex(&#123;<span class="attr">area</span>: <span class="string">"2dsphere"</span>&#125;)</span><br><span class="line"><span class="comment">//$geoIntersect可以找出與特定area有相交的點或面。以下query會回傳Golden Gate Park，如果該點與多個面有相交，那就會回傳所有的面</span></span><br><span class="line"><span class="comment">//不只可以query點對面，也可以面對面</span></span><br><span class="line">db.areas.find(&#123;<span class="attr">area</span>: &#123;<span class="attr">$geoIntersects</span>: &#123;<span class="attr">$geometry</span>: &#123;<span class="attr">type</span>: <span class="string">"Point"</span>, <span class="attr">coordinates</span>: [<span class="number">-122.49089</span>, <span class="number">37.76992</span>]&#125;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="尋找存在特定方圓內的所有點"><a href="#尋找存在特定方圓內的所有點" class="headerlink" title="尋找存在特定方圓內的所有點"></a>尋找存在特定方圓內的所有點</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$certerSphere可以指定一個點和一個距離半徑，此query會把距離此點的方圓半徑內的點找出來</span></span><br><span class="line"><span class="comment">//距離要自行從公尺或英里轉換成radians(弧度)，可以參考官方文件，以下範例是用公里轉換</span></span><br><span class="line">db.places.find(&#123;<span class="attr">location</span>: &#123;<span class="attr">$geoWithin</span>: &#123;<span class="attr">$centerSphere</span>: [[<span class="number">-122.46203</span>, <span class="number">37.77286</span>], <span class="number">1</span>/<span class="number">6378.1</span>]&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="Aggregation-Pipeline-Stages"><a href="#Aggregation-Pipeline-Stages" class="headerlink" title="Aggregation Pipeline Stages"></a>Aggregation Pipeline Stages</h1><ul>
<li>使用aggregate方法我們可以將多個query條件組合在一起</li>
<li>前一個條件的輸出將會變成後面條件的輸入，可以使用的method可以參考<a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/" target="_blank" rel="noopener">官網</a></li>
</ul>
<hr>
<ul>
<li>$group: 此方法可以根據documents的某一個field進行分群，裡面可以定義需要的field。group將多個document合而為一</li>
<li>$project: 此方法可以選擇需要哪些field被傳到下一個pipeline，可以是已經存在的field或是自己定義新的field。project是一對一的關係</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//以下query會先過濾出gender是female的document，再根據group創造出新的輸出</span></span><br><span class="line"><span class="comment">//aggregate外面是一個陣列，每個stage為一個structure</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; <span class="attr">$match</span>: &#123; <span class="attr">gender</span>: <span class="string">'female'</span> &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">$group</span>: &#123; <span class="attr">_id</span>: &#123; <span class="attr">state</span>: <span class="string">"$location.state"</span> &#125;, <span class="attr">totalPersons</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125; &#125; &#125;</span><br><span class="line">]).pretty();</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"berkshire"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">1</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"indre-et-loire"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">1</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"loiret"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">1</span> &#125;</span><br><span class="line"><span class="comment">//....省略</span></span><br><span class="line"><span class="comment">//加入sort，可以針對自己產生的field進行排序</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; <span class="attr">$match</span>: &#123; <span class="attr">gender</span>: <span class="string">'female'</span> &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">$group</span>: &#123; <span class="attr">_id</span>: &#123; <span class="attr">state</span>: <span class="string">"$location.state"</span> &#125;, <span class="attr">totalPersons</span>: &#123; <span class="attr">$sum</span>: <span class="number">1</span> &#125; &#125; &#125;,</span><br><span class="line">    &#123; <span class="attr">$sort</span>: &#123;<span class="attr">totalPersons</span>: <span class="number">-1</span>&#125;&#125;</span><br><span class="line">]).pretty();</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"midtjylland"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">33</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"nordjylland"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">27</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : &#123; <span class="string">"state"</span> : <span class="string">"syddanmark"</span> &#125;, <span class="string">"totalPersons"</span> : <span class="number">24</span> &#125;</span><br><span class="line"><span class="comment">//....省略</span></span><br><span class="line"></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; </span><br><span class="line">        $project: &#123; <span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">gender</span>: <span class="number">1</span>, </span><br><span class="line">        fullName: &#123; </span><br><span class="line">            <span class="comment">//$concat可以連接字串，需要用一個array將要連接的字串包起來</span></span><br><span class="line">            <span class="comment">//$toUpper可以將字母小寫轉成大寫</span></span><br><span class="line">            $concat: [&#123; <span class="attr">$toUpper</span>: <span class="string">"$name.first"</span> &#125;, <span class="string">" "</span>, &#123; <span class="attr">$toUpper</span>: <span class="string">"$name.last"</span> &#125;] </span><br><span class="line">            &#125; &#125; &#125;</span><br><span class="line">]).pretty()</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"gender"</span> : <span class="string">"male"</span>, <span class="string">"fullName"</span> : <span class="string">"VICTOR PEDERSEN"</span> &#125;</span><br><span class="line">&#123; <span class="string">"gender"</span> : <span class="string">"male"</span>, <span class="string">"fullName"</span> : <span class="string">"CARL JACOBS"</span> &#125;</span><br><span class="line">&#123; <span class="string">"gender"</span> : <span class="string">"male"</span>, <span class="string">"fullName"</span> : <span class="string">"ZACHARY LO"</span> &#125;</span><br><span class="line"><span class="comment">//如果只需要轉換名字的第一個字母為大小，可以使用更複雜的操作</span></span><br><span class="line"><span class="comment">//把$name.first拆成第一個字母和剩下的字母，只針對第一個字母做大小寫轉換，再把剩下的字串連在一起</span></span><br><span class="line"><span class="comment">//$substrCP可以拆解字串，第一個參數為拆解的對象，第二個參數為從哪個index開始，第三個參數為需要幾個element</span></span><br><span class="line"><span class="comment">//$strLenCP幫助我們得知字串的長度</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; </span><br><span class="line">        $project: &#123; </span><br><span class="line">            _id: <span class="number">0</span>, </span><br><span class="line">            gender: <span class="number">1</span>, </span><br><span class="line">            fullName: &#123; </span><br><span class="line">                $concat: [</span><br><span class="line">                    &#123; </span><br><span class="line">                        $toUpper: &#123;<span class="attr">$substrCP</span>: [<span class="string">'$name.first'</span>, <span class="number">0</span>, <span class="number">1</span>]&#125;&#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//使用$subtract減1是因為要扣掉第一個字母的長度</span></span><br><span class="line">                            $substrCP: [<span class="string">'$name.first'</span>, <span class="number">1</span>, &#123;<span class="attr">$subtract</span>: [&#123; <span class="attr">$strLenCP</span>: <span class="string">'$name.first'</span>&#125;, <span class="number">1</span>]&#125;]</span><br><span class="line">                        &#125;,</span><br><span class="line">                         <span class="string">" "</span>, </span><br><span class="line">                         &#123; <span class="attr">$toUpper</span>: <span class="string">"$name.last"</span> &#125;</span><br><span class="line">                        ] </span><br><span class="line">                    &#125; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">]).pretty()</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"gender"</span> : <span class="string">"male"</span>, <span class="string">"fullName"</span> : <span class="string">"Victor PEDERSEN"</span> &#125;</span><br><span class="line">&#123; <span class="string">"gender"</span> : <span class="string">"male"</span>, <span class="string">"fullName"</span> : <span class="string">"Carl JACOBS"</span> &#125;</span><br><span class="line"><span class="comment">//甚至可以結合兩個$project，後面的project將會使用前面的project的結果當作輸入</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; </span><br><span class="line">        $project:&#123;</span><br><span class="line">            _id: <span class="number">0</span>,</span><br><span class="line">            name: <span class="number">1</span>,<span class="comment">//在下一個project會進行上個例子一樣的操作</span></span><br><span class="line">            email: <span class="number">1</span>,</span><br><span class="line">            location:&#123;</span><br><span class="line">                type: <span class="string">"Point"</span>,</span><br><span class="line">                coordinates:[</span><br><span class="line">                    <span class="comment">//convert可以轉換資料型態</span></span><br><span class="line">                    &#123;<span class="attr">$convert</span>: &#123;<span class="attr">input</span>: <span class="string">'$location.coordinates.longitude'</span>, <span class="attr">to</span>: <span class="string">"double"</span>, <span class="attr">onError</span>: <span class="number">0.0</span>, <span class="attr">onNull</span>: <span class="number">0.0</span>&#125;&#125;,</span><br><span class="line">                    &#123;<span class="attr">$convert</span>: &#123;<span class="attr">input</span>: <span class="string">'$location.coordinates.latitude'</span>, <span class="attr">to</span>: <span class="string">"double"</span>, <span class="attr">onError</span>: <span class="number">0.0</span>, <span class="attr">onNull</span>: <span class="number">0.0</span>&#125;&#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;&#125;,&#123;</span><br><span class="line">        $project: &#123; </span><br><span class="line">            gender: <span class="number">1</span>, </span><br><span class="line">            email: <span class="number">1</span>,</span><br><span class="line">            location: <span class="number">1</span>,</span><br><span class="line">            fullName: &#123; <span class="attr">$concat</span>: [&#123; <span class="attr">$toUpper</span>: &#123;<span class="attr">$substrCP</span>: [<span class="string">'$name.first'</span>, <span class="number">0</span>, <span class="number">1</span>]&#125;&#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            $substrCP: [<span class="string">'$name.first'</span>, <span class="number">1</span>, &#123;<span class="attr">$subtract</span>: [&#123; <span class="attr">$strLenCP</span>: <span class="string">'$name.first'</span>&#125;, <span class="number">1</span>]&#125;]</span><br><span class="line">                        &#125;,</span><br><span class="line">                         <span class="string">" "</span>,&#123; <span class="attr">$toUpper</span>: <span class="string">"$name.last"</span> &#125;] &#125; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">]).pretty()</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="string">"location"</span> : &#123;</span><br><span class="line">                <span class="string">"type"</span> : <span class="string">"Point"</span>,</span><br><span class="line">                <span class="string">"coordinates"</span> : [</span><br><span class="line">                        <span class="number">130.0105</span>,</span><br><span class="line">                        <span class="number">88.1818</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="string">"email"</span> : <span class="string">"gonca.alnıaçık@example.com"</span>,</span><br><span class="line">    <span class="string">"fullName"</span> : <span class="string">"Gonca ALNıAçıK"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>$unwind: unwind方法可以接受一個array，並且根據array element的數量將document分割成多個，範例如下</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//friends範例裡的資料</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b28"</span>),</span><br><span class="line">        <span class="string">"name"</span> : <span class="string">"Max"</span>,</span><br><span class="line">        <span class="string">"hobbies"</span> : [</span><br><span class="line">                <span class="string">"Sports"</span>,</span><br><span class="line">                <span class="string">"Cooking"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"age"</span> : <span class="number">29</span>,</span><br><span class="line">        <span class="string">"examScores"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"difficulty"</span> : <span class="number">4</span>,</span><br><span class="line">                        <span class="string">"score"</span> : <span class="number">57.9</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"difficulty"</span> : <span class="number">6</span>,</span><br><span class="line">                        <span class="string">"score"</span> : <span class="number">62.1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"difficulty"</span> : <span class="number">3</span>,</span><br><span class="line">                        <span class="string">"score"</span> : <span class="number">88.5</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用unwind方法</span></span><br><span class="line">db.friends.aggregate([&#123;<span class="attr">$unwine</span>: <span class="string">"$hobbies"</span>&#125;])</span><br><span class="line"><span class="comment">//會變成</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b28"</span>),</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"Max"</span>,</span><br><span class="line">    <span class="string">"hobbies"</span> : <span class="string">"Sports"</span>,</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">29</span>,</span><br><span class="line">    <span class="string">"examScores"</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">4</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">57.9</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">6</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">62.1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">3</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">88.5</span></span><br><span class="line">            &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b28"</span>),</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"Max"</span>,</span><br><span class="line">    <span class="string">"hobbies"</span> : <span class="string">"Cooking"</span>,</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">29</span>,</span><br><span class="line">    <span class="string">"examScores"</span> : [</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">4</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">57.9</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">6</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">62.1</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                    <span class="string">"difficulty"</span> : <span class="number">3</span>,</span><br><span class="line">                    <span class="string">"score"</span> : <span class="number">88.5</span></span><br><span class="line">            &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$push可以將incoming data傳到array裡，所以allHobbies將會是一個array裡面再包多個array(因為hobbies是array)</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$group</span>: &#123;<span class="attr">_id</span>: &#123;<span class="attr">age</span>: <span class="string">"$age"</span>&#125;, <span class="attr">allHobbies</span>: &#123;<span class="attr">$push</span>: <span class="string">"$hobbies"</span>&#125;&#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//結合unwind就可以避免allHobbies裡面是array包array</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$unwind</span>: <span class="string">"$hobbies"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">$group</span>: &#123;<span class="attr">_id</span>: &#123;<span class="attr">age</span>: <span class="string">"$age"</span>&#125;, <span class="attr">allHobbies</span>: &#123;<span class="attr">$push</span>: <span class="string">"$hobbies"</span>&#125;&#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//但是上面的方法allHobbies可能會有重複的element，可以將push改成addToSet改善這個問題</span></span><br><span class="line"><span class="comment">//$addToSet不會把重複的資料push進array裡</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$unwind</span>: <span class="string">"$hobbies"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">$group</span>: &#123;<span class="attr">_id</span>: &#123;<span class="attr">age</span>: <span class="string">"$age"</span>&#125;, <span class="attr">allHobbies</span>: &#123;<span class="attr">$addToSet</span>: <span class="string">"$hobbies"</span>&#125;&#125;&#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果只要擷取array的部分element到新定義的field，可以使用$slice</span></span><br><span class="line"><span class="comment">//$slice接受一個array做為參數，第一個element為要擷取的對象array</span></span><br><span class="line"><span class="comment">//如果$slice接受的array參數只有兩個element，第二個element為從index0開始需要幾個element(正數)，或從最後一個element開始需要幾個element(負數)</span></span><br><span class="line"><span class="comment">//如果$slice接受的array參數有三個element，第二個為從index幾開始，第三個為需要幾個element</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$project</span>: &#123;<span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">examScore</span>: &#123;<span class="attr">$slice</span>: [<span class="string">"$examScores"</span>, <span class="number">1</span>]&#125;&#125;&#125;<span class="comment">//只會擷取第一個element作為examScore的參數</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以結合project，只顯示array中分數大於特定值得element</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$project</span>: &#123;</span><br><span class="line">        _id: <span class="number">0</span>, </span><br><span class="line">        <span class="comment">//這裡的sc要加兩個$是因為如果只有一個$，mongodb會以為是原始資料的sc field而不是我們自己定義的sr field</span></span><br><span class="line">        scores: &#123;<span class="attr">$filter</span>: &#123;<span class="attr">input</span>: <span class="string">"$examScores"</span>, <span class="attr">as</span>: <span class="string">"sc"</span>, <span class="attr">cond</span>: &#123;<span class="attr">$gt</span>: [<span class="string">"$$sc.score"</span>, <span class="number">60</span>]&#125;&#125;&#125; </span><br><span class="line">        &#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//回傳</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"scores"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"difficulty"</span> : <span class="number">6</span>,</span><br><span class="line">            <span class="string">"score"</span> : <span class="number">62.1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"difficulty"</span> : <span class="number">3</span>,</span><br><span class="line">            <span class="string">"score"</span> : <span class="number">88.5</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果只需要顯示一個人所得到的最高成績，可以用以下方法</span></span><br><span class="line">db.friends.aggregate([</span><br><span class="line">    &#123;<span class="attr">$unwind</span>: <span class="string">"examScores"</span>&#125;,<span class="comment">//先根據成績分開document，這樣一個document就會只擁有一個成績</span></span><br><span class="line">    &#123;<span class="attr">$project</span>: &#123;<span class="attr">_id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">age</span>:<span class="number">1</span> ,<span class="attr">score</span>: <span class="string">"$examScores.score"</span>&#125;&#125;,<span class="comment">//examScores是一個structure，我們只需要score的部分</span></span><br><span class="line">    &#123;<span class="attr">$sort</span>: &#123;<span class="attr">score</span>: <span class="number">-1</span>&#125;&#125;,<span class="comment">//成績由大排到小</span></span><br><span class="line">    <span class="comment">//$first可以在一個group中使用第一個element的參數當作整個group的某一個field的參數</span></span><br><span class="line">    &#123;<span class="attr">$group</span>: &#123;<span class="attr">_id</span>: <span class="string">"$_id"</span>, <span class="attr">name</span>: &#123;<span class="attr">$first</span>: <span class="string">"$name"</span>&#125;, <span class="attr">maxScore</span>: &#123;<span class="attr">$max</span>: <span class="string">"$score"</span>&#125;&#125;&#125;,</span><br><span class="line">    &#123;<span class="attr">$sort</span>: &#123;<span class="attr">maxScore</span>: <span class="number">-1</span>&#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b28"</span>), <span class="string">"name"</span> : <span class="string">"Max"</span>, <span class="string">"maxScore"</span> : <span class="number">88.5</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b2a"</span>), <span class="string">"name"</span> : <span class="string">"Maria"</span>, <span class="string">"maxScore"</span> : <span class="number">75.1</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d64e4156116a09c69665b29"</span>), <span class="string">"name"</span> : <span class="string">"Manu"</span>, <span class="string">"maxScore"</span> : <span class="number">74.3</span> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>$bucket: bucket可以讓我們對輸入的資料進行分群，並產生我們需要的field</li>
<li>$bucketAuto: 相較於bucket，bucketAuto可以自動幫我們產生group的區間</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123;<span class="attr">$bucket</span>: &#123;</span><br><span class="line">        groupBy: <span class="string">"$dob.age"</span>,<span class="comment">//定義針對哪個field做分群</span></span><br><span class="line">        boundaries: [<span class="number">0</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">80</span>, <span class="number">120</span>],<span class="comment">//分群的區間</span></span><br><span class="line">        output: &#123;</span><br><span class="line">            numPerson: &#123;<span class="attr">$sum</span>: <span class="number">1</span>&#125;,</span><br><span class="line">            averageAge: &#123;<span class="attr">$avg</span>: <span class="string">"$dob.age"</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="number">18</span>, <span class="string">"numPerson"</span> : <span class="number">868</span>, <span class="string">"averageAge"</span> : <span class="number">25.101382488479263</span> &#125;<span class="comment">//18-29</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="number">30</span>, <span class="string">"numPerson"</span> : <span class="number">1828</span>, <span class="string">"averageAge"</span> : <span class="number">39.4917943107221</span> &#125;<span class="comment">//30-19</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : <span class="number">50</span>, <span class="string">"numPerson"</span> : <span class="number">2304</span>, <span class="string">"averageAge"</span> : <span class="number">61.46440972222222</span> &#125;<span class="comment">//50-79</span></span><br><span class="line"><span class="comment">//使用bucketAuto</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123;<span class="attr">$bucketAuto</span>: &#123;</span><br><span class="line">        groupBy: <span class="string">"$dob.age"</span>,</span><br><span class="line">        buckets: <span class="number">5</span>,<span class="comment">//mongodb會自動產生5個區間</span></span><br><span class="line">        output: &#123;</span><br><span class="line">            numPerson: &#123;<span class="attr">$sum</span>: <span class="number">1</span>&#125;,</span><br><span class="line">            averageAge: &#123;<span class="attr">$avg</span>: <span class="string">"$dob.age"</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : <span class="number">21</span>,</span><br><span class="line">            <span class="string">"max"</span> : <span class="number">32</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"numPerson"</span> : <span class="number">1042</span>,</span><br><span class="line">    <span class="string">"averageAge"</span> : <span class="number">25.99616122840691</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : <span class="number">32</span>,</span><br><span class="line">            <span class="string">"max"</span> : <span class="number">43</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"numPerson"</span> : <span class="number">1010</span>,</span><br><span class="line">    <span class="string">"averageAge"</span> : <span class="number">36.97722772277228</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : <span class="number">43</span>,</span><br><span class="line">            <span class="string">"max"</span> : <span class="number">54</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"numPerson"</span> : <span class="number">1033</span>,</span><br><span class="line">    <span class="string">"averageAge"</span> : <span class="number">47.98838334946757</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : <span class="number">54</span>,</span><br><span class="line">            <span class="string">"max"</span> : <span class="number">65</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"numPerson"</span> : <span class="number">1064</span>,</span><br><span class="line">    <span class="string">"averageAge"</span> : <span class="number">58.99342105263158</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">"_id"</span> : &#123;</span><br><span class="line">            <span class="string">"min"</span> : <span class="number">65</span>,</span><br><span class="line">            <span class="string">"max"</span> : <span class="number">74</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"numPerson"</span> : <span class="number">851</span>,</span><br><span class="line">    <span class="string">"averageAge"</span> : <span class="number">69.11515863689776</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//假設我們要找出最老的5個人</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; <span class="attr">$project</span>: &#123;<span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">name</span>: &#123;<span class="attr">$concat</span>: [<span class="string">"$name.first"</span>,<span class="string">" "</span>, <span class="string">"$name.lst"</span>]&#125;, <span class="attr">birthdate</span>: &#123;<span class="attr">$toDate</span>: <span class="string">"$dob.date"</span>&#125;&#125;&#125;,</span><br><span class="line">    &#123; <span class="attr">$sort</span>: &#123;<span class="attr">birthdate</span>: <span class="number">1</span>&#125;&#125;,</span><br><span class="line">    &#123; <span class="attr">$limit</span>: <span class="number">5</span>&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//回傳如下</span></span><br><span class="line">&#123; <span class="string">"name"</span> : <span class="literal">null</span>, <span class="string">"birthdate"</span> : ISODate(<span class="string">"1944-09-07T15:52:50Z"</span>) &#125;</span><br><span class="line">&#123; <span class="string">"name"</span> : <span class="literal">null</span>, <span class="string">"birthdate"</span> : ISODate(<span class="string">"1944-09-12T07:49:20Z"</span>) &#125;</span><br><span class="line">&#123; <span class="string">"name"</span> : <span class="literal">null</span>, <span class="string">"birthdate"</span> : ISODate(<span class="string">"1944-09-13T14:58:41Z"</span>) &#125;</span><br><span class="line">&#123; <span class="string">"name"</span> : <span class="literal">null</span>, <span class="string">"birthdate"</span> : ISODate(<span class="string">"1944-09-16T16:03:28Z"</span>) &#125;</span><br><span class="line">&#123; <span class="string">"name"</span> : <span class="literal">null</span>, <span class="string">"birthdate"</span> : ISODate(<span class="string">"1944-09-17T15:04:13Z"</span>) &#125;</span><br><span class="line"><span class="comment">//如果要再取得下5筆資料，可以加上skip</span></span><br><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123; <span class="attr">$project</span>: &#123;<span class="attr">_id</span>: <span class="number">0</span>, <span class="attr">name</span>: &#123;<span class="attr">$concat</span>: [<span class="string">"$name.first"</span>,<span class="string">" "</span>, <span class="string">"$name.lst"</span>]&#125;, <span class="attr">birthdate</span>: &#123;<span class="attr">$toDate</span>: <span class="string">"$dob.date"</span>&#125;&#125;&#125;,</span><br><span class="line">    &#123; <span class="attr">$sort</span>: &#123;<span class="attr">birthdate</span>: <span class="number">1</span>&#125;&#125;,</span><br><span class="line">    &#123; <span class="attr">$skip</span>: <span class="number">5</span>&#125;,</span><br><span class="line">    &#123; <span class="attr">$limit</span>: <span class="number">5</span>&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<ul>
<li>$out: 將out放在aggregation的最後可以將整個結果存到指定的collection</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">db.persons.aggregate([</span><br><span class="line">    &#123;</span><br><span class="line">      $project: &#123;</span><br><span class="line">        _id: <span class="number">0</span>, <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">email</span>: <span class="number">1</span>,  <span class="attr">birthdate</span>: &#123; <span class="attr">$toDate</span>: <span class="string">'$dob.date'</span> &#125;,</span><br><span class="line">        age: <span class="string">"$dob.age"</span>,</span><br><span class="line">        location: &#123;</span><br><span class="line">          type: <span class="string">'Point'</span>,</span><br><span class="line">          coordinates: [</span><br><span class="line">            &#123;</span><br><span class="line">              $convert: &#123;</span><br><span class="line">                input: <span class="string">'$location.coordinates.longitude'</span>,</span><br><span class="line">                to: <span class="string">'double'</span>,</span><br><span class="line">                onError: <span class="number">0.0</span>,</span><br><span class="line">                onNull: <span class="number">0.0</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              $convert: &#123;</span><br><span class="line">                input: <span class="string">'$location.coordinates.latitude'</span>,</span><br><span class="line">                to: <span class="string">'double'</span>,</span><br><span class="line">                onError: <span class="number">0.0</span>,</span><br><span class="line">                onNull: <span class="number">0.0</span></span><br><span class="line">              &#125;&#125;]&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      $project: &#123;</span><br><span class="line">        gender: <span class="number">1</span>, <span class="attr">email</span>: <span class="number">1</span>,<span class="attr">location</span>: <span class="number">1</span>, <span class="attr">birthdate</span>: <span class="number">1</span>, <span class="attr">age</span>: <span class="number">1</span>,</span><br><span class="line">        fullName: &#123;</span><br><span class="line">          $concat: [</span><br><span class="line">            &#123; <span class="attr">$toUpper</span>: &#123; <span class="attr">$substrCP</span>: [<span class="string">'$name.first'</span>, <span class="number">0</span>, <span class="number">1</span>] &#125; &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              $substrCP: [</span><br><span class="line">                <span class="string">'$name.first'</span>,</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                &#123; <span class="attr">$subtract</span>: [&#123; <span class="attr">$strLenCP</span>: <span class="string">'$name.first'</span> &#125;, <span class="number">1</span>] &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">' '</span>,</span><br><span class="line">            &#123; <span class="attr">$toUpper</span>: &#123; <span class="attr">$substrCP</span>: [<span class="string">'$name.last'</span>, <span class="number">0</span>, <span class="number">1</span>] &#125; &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              $substrCP: [</span><br><span class="line">                <span class="string">'$name.last'</span>,</span><br><span class="line">                <span class="number">1</span>,</span><br><span class="line">                &#123; <span class="attr">$subtract</span>: [&#123; <span class="attr">$strLenCP</span>: <span class="string">'$name.last'</span> &#125;, <span class="number">1</span>] &#125;</span><br><span class="line">              ]&#125;]&#125;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">$out</span>: <span class="string">"transformedPersons"</span> &#125; <span class="comment">//該collection可以是現存的或不存在的</span></span><br><span class="line">  ]).pretty();</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//aggregation也可以操作geo資料</span></span><br><span class="line"><span class="comment">//首先必須加入geo index</span></span><br><span class="line">db.transformPersons.createIndex(&#123;<span class="attr">location</span>: <span class="string">"2dsphere"</span>&#125;)</span><br><span class="line"><span class="comment">//$geoNear可以找出離某點最近的其他點，但要注意的是必須在aggregation的第一個stage</span></span><br><span class="line">db.transformedPersons.aggregate([</span><br><span class="line">    &#123;</span><br><span class="line">      $geoNear: &#123;</span><br><span class="line">        near: &#123;</span><br><span class="line">          type: <span class="string">'Point'</span>,</span><br><span class="line">          coordinates: [<span class="number">-18.4</span>, <span class="number">-42.8</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        maxDistance: <span class="number">1000000</span>,</span><br><span class="line">        num: <span class="number">10</span>,</span><br><span class="line">        query: &#123; <span class="attr">age</span>: &#123; <span class="attr">$gt</span>: <span class="number">30</span> &#125; &#125;,</span><br><span class="line">        distanceField: <span class="string">"distance"</span><span class="comment">//mongodb會幫我們算離該點的距離，所以要指定一個field存距離，名字可以隨意決定</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]).pretty();</span><br><span class="line"><span class="comment">//回傳如下(只擷取一個)</span></span><br><span class="line">    <span class="string">"_id"</span> : ObjectId(<span class="string">"5d654a7c5b563b45f720b2cd"</span>),</span><br><span class="line">    <span class="string">"location"</span> : &#123;</span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"Point"</span>,</span><br><span class="line">            <span class="string">"coordinates"</span> : [</span><br><span class="line">                    <span class="number">-18.5996</span>,</span><br><span class="line">                    <span class="number">-42.6128</span></span><br><span class="line">            ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"email"</span> : <span class="string">"elijah.lewis@example.com"</span>,</span><br><span class="line">    <span class="string">"birthdate"</span> : ISODate(<span class="string">"1986-03-29T06:40:18Z"</span>),</span><br><span class="line">    <span class="string">"age"</span> : <span class="number">32</span>,</span><br><span class="line">    <span class="string">"fullName"</span> : <span class="string">"Elijah Lewis"</span>,</span><br><span class="line">    <span class="string">"distance"</span> : <span class="number">26473.52536319881</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Numeric-Data"><a href="#Numeric-Data" class="headerlink" title="Numeric Data"></a>Numeric Data</h1><h2 id="MongoDB的四種數字型態"><a href="#MongoDB的四種數字型態" class="headerlink" title="MongoDB的四種數字型態"></a>MongoDB的四種數字型態</h2><ul>
<li>Intergers (int32): 純整數</li>
<li>Longs (int64): 純整數</li>
<li>Doubles (64bit): 包含小數。不論有沒有小數，如果沒有特別指定就預設為該型態(因為mongo shell是基於javascript環境)</li>
<li>High precisions doubles (128bit): 包含小數</li>
</ul>
<table>
<thead>
<tr>
<th align="left">Intergers (int32)</th>
<th align="left">Longs (int64)</th>
<th align="left">Doubles (64bit)</th>
<th align="left">High precisions doubles (128bit)</th>
</tr>
</thead>
<tbody><tr>
<td align="left">純整數</td>
<td align="left">純整數</td>
<td align="left">包含小數</td>
<td align="left">包含小數</td>
</tr>
<tr>
<td align="left">-2,147,483,648 到 2,147,483,647</td>
<td align="left">-9,223,372,036,854,775,808 到 9,223,372,036,854,775,807</td>
<td align="left">小數不保證精準</td>
<td align="left">小數高精準(34位小數內)</td>
</tr>
</tbody></table>
<ul>
<li>如果在其他language driver，預設可能不是doubles(64bit)，例如python的環境預設為(int32)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//age:29會以doubles(64bit)的方式被儲存，實際上在小數點後好幾位並不能保證全是0</span></span><br><span class="line">db.persons.insertOne(&#123;<span class="attr">age</span>: <span class="number">29</span>&#125;)</span><br><span class="line"><span class="comment">//如果我們要以int(int32)去儲存他，可以這樣做</span></span><br><span class="line">db.persons.insertOne(&#123;<span class="attr">age</span>: NumberInt(<span class="number">29</span>)&#125;)</span><br><span class="line">db.persons.insertOne(&#123;<span class="attr">age</span>: NumberInt(<span class="string">"29"</span>)&#125;)<span class="comment">//結果與上面一樣</span></span><br><span class="line"><span class="comment">//如果使用int32儲存超過範圍的數字，不會有error但錯誤的內容會被儲存</span></span><br><span class="line">db.conpanies.insertMany([</span><br><span class="line">    &#123;<span class="attr">valuation</span>: NumberInt(<span class="string">"5000000000"</span>)&#125;,</span><br><span class="line">    &#123;<span class="attr">valuation</span>: NumberInt(<span class="string">"2147483647"</span>)&#125;,</span><br><span class="line">    &#123;<span class="attr">valuation</span>: NumberInt(<span class="string">"2147483648"</span>)&#125;</span><br><span class="line">])</span><br><span class="line"><span class="comment">//使用find察看結果</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d6602d58a9830cd604283c2"</span>), <span class="string">"valuation"</span> : <span class="number">705032704</span> &#125;</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d6602d58a9830cd604283c3"</span>), <span class="string">"valuation"</span> : <span class="number">2147483647</span> &#125;<span class="comment">//只有他在範圍內</span></span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d6602d58a9830cd604283c4"</span>), <span class="string">"valuation"</span> : <span class="number">-2147483648</span> &#125;</span><br><span class="line"><span class="comment">//以下結果會被正常儲存，因為預設的double(64bit)的範圍更大</span></span><br><span class="line">db.conpanies.insertOne(&#123;<span class="attr">valuation</span>: <span class="number">2147483648</span>&#125;)</span><br><span class="line"><span class="comment">//要注意的是如果要儲存為long，如果傳入的數字不是字串且超過double(64bit)就必須使用字串的方式，因為數字在傳入NumberLong之前還是double</span></span><br><span class="line"><span class="comment">//以下結果會error</span></span><br><span class="line">db.conpanies.insertOne(&#123;<span class="attr">valuation</span>: NumberLong(<span class="number">9223372036854775807</span>)&#125;)</span><br><span class="line"><span class="comment">//以下結果會正常儲存</span></span><br><span class="line">db.conpanies.insertOne(&#123;<span class="attr">valuation</span>: NumberLong(<span class="string">"9223372036854775807"</span>)&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>雖然將數字都存這字串就不會有超過大小的問題，但是就不能使用$inc等運算子來做數學運算</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.accounts.insertOne(&#123;<span class="attr">name</span>: <span class="string">"Max"</span>, <span class="attr">amount</span>: NumberInt(<span class="string">"10"</span>)&#125;)</span><br><span class="line"><span class="comment">//要注意這邊加完後的結果會變成以double的型態儲存，因為int(int32)加上double會變成double的方式儲存</span></span><br><span class="line">db.accounts.updateMany(&#123;&#125;, &#123;<span class="attr">$inc</span>: &#123;<span class="attr">amount</span>: <span class="number">10</span>&#125;&#125;)</span><br><span class="line"><span class="comment">//所以必須以下面方式做加減</span></span><br><span class="line">db.accounts.updateMany(&#123;&#125;, &#123;<span class="attr">$inc</span>: &#123;<span class="attr">amount</span>: NumberInt(<span class="string">"10"</span>)&#125;&#125;)</span><br><span class="line"><span class="comment">//使用find查看結果，amount雖然沒有特別顯示NumberInt(因為預設的顯示方式)，但實際上是以NumberInt儲存</span></span><br></pre></td></tr></table></figure>

<ul>
<li>double不精準的證明</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db.test.insertOne(&#123;<span class="attr">a</span>: <span class="number">0.3</span>, <span class="attr">b</span>: <span class="number">0.1</span>&#125;)</span><br><span class="line"><span class="comment">//如果把a - b會發現不是0.2</span></span><br><span class="line">db.test.aggregate([&#123;<span class="attr">$project</span>: &#123;<span class="attr">result</span>: &#123;<span class="attr">$subtract</span>: [<span class="string">"$a"</span>, <span class="string">"$b"</span>]&#125;&#125;&#125;])</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d6609c98a9830cd604283c5"</span>), <span class="string">"result"</span> : <span class="number">0.19999999999999998</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用NumberDecimal可以解決該問題</span></span><br><span class="line">db.test.insertOne(&#123;<span class="attr">a</span>: NumberDecimal(<span class="string">"0.3"</span>), <span class="attr">b</span>: NumberDecimal(<span class="string">"0.1"</span>)&#125;)</span><br><span class="line"><span class="comment">//可以得到正確的結果</span></span><br><span class="line">db.test.aggregate([&#123;<span class="attr">$project</span>: &#123;<span class="attr">result</span>: &#123;<span class="attr">$subtract</span>: [<span class="string">"$a"</span>, <span class="string">"$b"</span>]&#125;&#125;&#125;])</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5d660b9e8a9830cd604283c6"</span>), <span class="string">"result"</span> : NumberDecimal(<span class="string">"0.2"</span>) &#125;</span><br><span class="line"><span class="comment">//如果要針對特殊形態做運算，最好都使用目標的型態(雙方一樣的型態)，且為了確保轉換正確，使用字串傳入的方式為佳</span></span><br></pre></td></tr></table></figure>

<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p>Float vs Double vs Decimal<a href="https://stackoverflow.com/questions/618535/difference-between-decimal-float-and-double-in-net" target="_blank" rel="noopener">連結</a><br>Modelling Number/ Monetary Data in MongoDB<a href="https://docs.mongodb.com/manual/tutorial/model-monetary-data/" target="_blank" rel="noopener">連結</a></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/backend/" rel="tag"># backend</a>
            
              <a href="/tags/database/" rel="tag"># database</a>
            
              <a href="/tags/mongoDB/" rel="tag"># mongoDB</a>
            
              <a href="/tags/mongo-shell/" rel="tag"># mongo shell</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/08/10/mongodb/" rel="next" title="mongoDB 基礎">
                  <i class="fa fa-chevron-left"></i> mongoDB 基礎
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/08/28/mongodb/" rel="prev" title="mongoDB 基礎3">
                  mongoDB 基礎3 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Geospatial-Data"><span class="nav-number">1.</span> <span class="nav-text">Geospatial Data</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Geo-json架構"><span class="nav-number">1.1.</span> <span class="nav-text">Geo json架構</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用find找出與現在位置接近的點資料"><span class="nav-number">1.2.</span> <span class="nav-text">使用find找出與現在位置接近的點資料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#找出一個面積內所包含的點資料"><span class="nav-number">1.3.</span> <span class="nav-text">找出一個面積內所包含的點資料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#確認一個點資料-user-是否在一個特定的範圍內"><span class="nav-number">1.4.</span> <span class="nav-text">確認一個點資料(user)是否在一個特定的範圍內</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#尋找存在特定方圓內的所有點"><span class="nav-number">1.5.</span> <span class="nav-text">尋找存在特定方圓內的所有點</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Aggregation-Pipeline-Stages"><span class="nav-number">2.</span> <span class="nav-text">Aggregation Pipeline Stages</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Numeric-Data"><span class="nav-number">3.</span> <span class="nav-text">Numeric Data</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MongoDB的四種數字型態"><span class="nav-number">3.1.</span> <span class="nav-text">MongoDB的四種數字型態</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#參考資料"><span class="nav-number">4.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">YENCHENG LIU</p>
  <div class="site-description" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:yourname@gmail.com" title="E-Mail &rarr; mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YENCHENG LIU</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
